{% extends 'WareDGT/layout.html' %}
{% block title %}Review Load Request{% endblock %}

{% block content %}
<h1 class="page-title">Review ECX Load Request</h1>
<div class="erp-card">
  <div class="erp-card__header">Submission Overview</div>
  <div class="erp-card__body">
    <p><strong>Submitter:</strong> {{ request_obj.created_by.get_full_name|default:request_obj.created_by.username }}</p>
    <p><strong>Submitted:</strong> {{ request_obj.created_at }}</p>
    <p><strong>Warehouse:</strong> {{ request_obj.warehouse.name }}</p>
    <h3>Trades</h3>
    <table class="erp-table">
      <thead><tr><th>Receipt No</th><th>Quantity (Qtls)</th></tr></thead>
      <tbody>
      {% for t in request_obj.trades.all %}
      <tr>
        <td>{{ t.warehouse_receipt_no }}</td>
        <td>{{ t.quantity_quintals }}</td>
      </tr>
      {% endfor %}
      </tbody>
    </table>
    {% if request_obj.truck_image %}
    <p class="mt-3"><strong>Truck Image:</strong><br/><img src="{{ request_obj.truck_image.url }}" alt="Truck image" style="max-width:100%;margin-top:4px;"/></p>
    {% endif %}
    {% for rf in request_obj.receipt_files.all %}
    <p class="mt-3"><strong>Receipt:</strong><br/><img src="{{ rf.file.url }}" alt="Load request receipt" style="max-width:100%;margin-top:4px;"/></p>
    {% endfor %}
  </div>
</div>
{% if not token_ok %}
<div class="erp-alert erp-alert--warning">Approval token missing or invalid. Use the email link.</div>
{% endif %}
{% if request_obj.status == request_obj.STATUS_PENDING %}
<form method="post" class="mt-4">
  {% csrf_token %}
  <input type="hidden" name="t" value="{{ request.GET.t }}">
  <label>Reason
    <textarea name="note" rows="3" class="w-full"></textarea>
  </label>
  <div class="mt-3">
    <button type="submit" name="action" value="approve" class="erp-btn primary">Approve & Load</button>
    <button type="submit" name="action" value="decline" class="erp-btn danger">Decline</button>
  </div>
</form>
{% else %}
<p class="mt-4">Decision already recorded for this request.</p>
{% endif %}
{% endblock %}
